name: Send Telegram HTML

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "futbol/futbol.html"
      - "basketbol/basketbol.html"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2   # diff i√ßin gerekli

      - name: Detect changed HTML files
        id: detect
        run: |
          echo "üîç Deƒüi≈üen HTML dosyalarƒ± kontrol ediliyor..."

          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '^(futbol/futbol\.html|basketbol/basketbol\.html)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ö†Ô∏è Hi√ß deƒüi≈üiklik yok."
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "üìÇ Deƒüi≈üen dosyalar:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" > changed.txt
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: Send changed HTML files via Telegram
        if: steps.detect.outputs.found == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TZ: Europe/Istanbul
        run: |
          while read FILE; do
            if [ -f "$FILE" ]; then
              BASENAME=$(basename "$FILE")

              # üîπ ƒ∞kon se√ßimi
              if [[ "$FILE" == futbol/futbol.html ]]; then
                ICON="‚öΩ"
              elif [[ "$FILE" == basketbol/basketbol.html ]]; then
                ICON="üèÄ"
              else
                ICON="üìÅ"
              fi

              CAPTION="$ICON $BASENAME - $(date +'%d.%m.%Y %H:%M')"

              echo "üì§ G√∂nderiliyor: $FILE ($ICON)"
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" \
                -F chat_id="$TELEGRAM_CHAT_ID" \
                -F document="@$FILE" \
                -F caption="$CAPTION"

              echo "‚úÖ G√∂nderildi: $FILE"
            else
              echo "‚ö†Ô∏è Dosya bulunamadƒ±: $FILE"
            fi
          done < changed.txt
