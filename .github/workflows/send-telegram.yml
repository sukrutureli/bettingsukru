name: Send Telegram HTML

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "*.html"
      - "data/*.html"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Detect changed HTML files
        id: detect
        run: |
          echo "ðŸ” DeÄŸiÅŸen HTML dosyalarÄ± tespit ediliyor..."
          # head commitâ€™teki eklenen + deÄŸiÅŸen dosyalarÄ± listele
          CHANGED_FILES=$(jq -r '.head_commit.added[], .head_commit.modified[]' "$GITHUB_EVENT_PATH" | grep -E '\.html$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "âš ï¸ HiÃ§ yeni/deÄŸiÅŸen HTML dosyasÄ± yok."
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“‚ Bulunan dosyalar:"
            echo "$CHANGED_FILES"
            echo "found=true" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" > changed.txt
          fi

      - name: Send changed HTML files via Telegram
        if: steps.detect.outputs.found == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          while read FILE; do
            if [ -f "$FILE" ]; then
              echo "ðŸ“¤ GÃ¶nderiliyor: $FILE"
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" \
                -F chat_id="$TELEGRAM_CHAT_ID" \
                -F document="@$FILE" \
                -F caption="ðŸ“Š $(basename "$FILE") - $(date +'%d.%m.%Y')"
              echo "âœ… GÃ¶nderildi: $FILE"
            fi
          done < changed.txt
