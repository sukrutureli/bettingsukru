name: Send Telegram HTML

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "*.html"
      - "data/*.html"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2   # diff alabilmek i√ßin en az 2 commit gerekli

      - name: Detect changed HTML files
        id: detect
        run: |
          echo "üîç Deƒüi≈üen veya yeni eklenen HTML dosyalarƒ± tespit ediliyor..."
          
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.html$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ö†Ô∏è Hi√ß yeni/deƒüi≈üen HTML dosyasƒ± yok."
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "üìÇ Bulunan dosyalar:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" > changed.txt
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: Send changed HTML files via Telegram
        if: steps.detect.outputs.found == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TZ: Europe/Istanbul
        run: |
          while read FILE; do
            if [ -f "$FILE" ]; then
              BASENAME=$(basename "$FILE")

              # üîπ Emoji se√ßimi
              if [[ "$BASENAME" == *"futbol"* ]]; then
                ICON="‚öΩ"
              elif [[ "$BASENAME" == *"basketbol"* ]]; then
                ICON="üèÄ"
              elif [[ "$FILE" == data/* ]]; then
                ICON="üìä"
              else
                ICON="üìÅ"
              fi

              CAPTION="$ICON $(basename "$FILE") - $(date +'%d.%m.%Y %H:%M')"

              echo "üì§ G√∂nderiliyor: $BASENAME ($ICON)"
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" \
                -F chat_id="$TELEGRAM_CHAT_ID" \
                -F document="@$FILE" \
                -F caption="$CAPTION"
              echo "‚úÖ G√∂nderildi: $FILE"
            else
              echo "‚ö†Ô∏è Dosya bulunamadƒ± (silinmi≈ü olabilir): $FILE"
            fi
          done < changed.txt
