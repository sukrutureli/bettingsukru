name: Send Telegram HTML

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "*.html"
      - "data/*.html"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2   # üîπ diff alabilmek i√ßin en az 2 commit gerekli

      - name: Detect changed HTML files
        id: detect
        run: |
          echo "üîç Deƒüi≈üen veya yeni eklenen HTML dosyalarƒ± tespit ediliyor..."
          
          # Deƒüi≈üiklikleri bul: son commit ile bir √∂nceki commit arasƒ± fark
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.html$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ö†Ô∏è Hi√ß yeni/deƒüi≈üen HTML dosyasƒ± yok."
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "üìÇ Bulunan dosyalar:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" > changed.txt
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: Send changed HTML files via Telegram
        if: steps.detect.outputs.found == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          while read FILE; do
            if [ -f "$FILE" ]; then
              echo "üì§ G√∂nderiliyor: $FILE"
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" \
                -F chat_id="$TELEGRAM_CHAT_ID" \
                -F document="@$FILE" \
                -F caption="üìä $(basename "$FILE") - $(date +'%d.%m.%Y')"
              echo "‚úÖ G√∂nderildi: $FILE"
            else
              echo "‚ö†Ô∏è Dosya bulunamadƒ± (belki silinmi≈ü): $FILE"
            fi
          done < changed.txt
