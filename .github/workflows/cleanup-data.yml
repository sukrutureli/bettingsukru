name: Cleanup Old JSON Files (by Date in Filename)

on:
  schedule:
    - cron: '0 2 * * *'   # UTC 02:00 -> TÃ¼rkiye saati 05:00 civarÄ±, her gÃ¼n Ã§alÄ±ÅŸÄ±r
  workflow_dispatch:        # Manuel tetikleme seÃ§eneÄŸi

permissions:
  contents: write           # Commit/push yapabilmek iÃ§in gerekli izin

jobs:
  cleanup:
    name: Delete old JSONs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show current date
        run: date -u

      - name: Delete JSON files older than 7 days (based on date in filename)
        run: |
          echo "ğŸ§¹ Starting cleanup in ./data ..."
          if [ ! -d "data" ]; then
            echo "âš ï¸ data directory not found, skipping."
            exit 0
          fi

          # Kesim tarihi: 6 gÃ¼n Ã¶nce (bugÃ¼n + son 6 gÃ¼n kalacak)
          CUTOFF=$(date -u -d '6 days ago' +%Y-%m-%d)
          echo "Cutoff date: $CUTOFF"

          deleted_any=false

          # TÃ¼m .json dosyalarÄ± Ã¼zerinde dÃ¶n
          find data/ -type f -name "*.json" | while read -r file; do
            filename=$(basename "$file")

            # YYYY-MM-DD formatÄ±ndaki tarihi yakala
            datepart=$(echo "$filename" | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' || true)
            if [ -z "$datepart" ]; then
              continue
            fi

            # Tarihi karÅŸÄ±laÅŸtÄ±r (ASCII kÄ±yaslama yeterli)
            if [[ "$datepart" < "$CUTOFF" ]]; then
              echo "ğŸ—‘ï¸  Deleting $file (date $datepart < cutoff $CUTOFF)"
              rm -f "$file"
              deleted_any=true
            fi
          done

          # EÄŸer hiÃ§bir dosya silinmediyse bilgi ver
          if [ "$deleted_any" = false ]; then
            echo "âœ… No files to delete."
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "ğŸŸ¢ No changes to commit."
          else
            git commit -m "Auto-cleanup: removed JSON files older than 7 days"
            git push
            echo "âœ… Changes pushed."
          fi
