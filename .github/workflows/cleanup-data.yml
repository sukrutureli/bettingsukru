name: Cleanup Old Files (JSON + HTML by Date in Filename)

on:
  schedule:
    - cron: '0 2 * * *'   # UTC 02:00 ‚Üí T√ºrkiye 05:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    name: Delete old JSON and HTML files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show current date
        run: date -u

      - name: Cleanup futbol/data and basketbol/data (older than 2 days)
        run: |
          # === PARAMETRELER ===
          CUTOFF=$(date -u -d '1 days ago' +%Y-%m-%d)
          echo "Cutoff date: $CUTOFF"

          deleted_any=false

          CLEAN_DIRS=("futbol/data" "basketbol/data")

          for DIR in "${CLEAN_DIRS[@]}"; do
            echo "üßπ Checking directory: $DIR"

            if [ ! -d "$DIR" ]; then
              echo "‚ö†Ô∏è Directory not found, skipping: $DIR"
              continue
            fi

            # JSON + HTML dosyalarƒ± tara
            find "$DIR" -type f \( -name "*.json" -o -name "*.html" \) | while read -r file; do
              filename=$(basename "$file")

              # Dosya adƒ±ndaki tarihe bak
              datepart=$(echo "$filename" | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' || true)
              if [ -z "$datepart" ]; then
                continue
              fi

              # Kar≈üƒ±la≈ütƒ±r
              if [[ "$datepart" < "$CUTOFF" ]]; then
                echo "üóëÔ∏è  Deleting $file (date $datepart < cutoff $CUTOFF)"
                rm -f "$file"
                deleted_any=true
              fi
            done
          done

          if [ "$deleted_any" = false ]; then
            echo "‚úÖ No files to delete."
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "üü¢ No changes to commit."
          else
            git commit -m "Auto-cleanup: removed files older than 2 days"
            git push
            echo "‚úÖ Changes pushed."
          fi
