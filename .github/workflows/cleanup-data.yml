name: Cleanup Old Files (JSON + HTML by Date in Filename)

on:
  schedule:
    - cron: '0 2 * * *'   # UTC 02:00 â†’ TÃ¼rkiye 05:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    name: Delete old JSON and HTML files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show current date
        run: date -u

      - name: Delete JSON/HTML files older than 7 days (based on date in filename)
        run: |
          echo "ğŸ§¹ Starting cleanup in ./data ..."
          if [ ! -d "data" ]; then
            echo "âš ï¸ data directory not found, skipping."
            exit 0
          fi

          # Kesim tarihi: son 6 gÃ¼n kalsÄ±n, 7+ gÃ¼n Ã¶ncesini sil
          CUTOFF=$(date -u -d '6 days ago' +%Y-%m-%d)
          echo "Cutoff date: $CUTOFF"

          deleted_any=false

          # ğŸ”¹ Hem .json hem .html dosyalarÄ±nÄ± tara
          find data/ -type f \( -name "*.json" -o -name "*.html" \) | while read -r file; do
            filename=$(basename "$file")

            # Dosya adÄ±ndaki YYYY-MM-DD formatlÄ± tarihi al
            datepart=$(echo "$filename" | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' || true)
            if [ -z "$datepart" ]; then
              continue
            fi

            # Tarihi karÅŸÄ±laÅŸtÄ±r (lexicographic comparison yeterli)
            if [[ "$datepart" < "$CUTOFF" ]]; then
              echo "ğŸ—‘ï¸  Deleting $file (date $datepart < cutoff $CUTOFF)"
              rm -f "$file"
              deleted_any=true
            fi
          done

          if [ "$deleted_any" = false ]; then
            echo "âœ… No files to delete."
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "ğŸŸ¢ No changes to commit."
          else
            git commit -m "Auto-cleanup: removed JSON/HTML files older than 7 days"
            git push
            echo "âœ… Changes pushed."
          fi
